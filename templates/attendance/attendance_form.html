{% extends 'attendance/base.html' %}
{% load phone_filters %}
{% block content %}
<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 sticky-filter">
  <h1 class="h4 mb-0">Attendance: {{ schoolyear.name }}</h1>
  <form id="date-form" method="get" class="d-flex align-items-center gap-2 flex-wrap">
    <div class="btn-group" role="group" aria-label="Quick date nav">
      <button class="btn btn-outline-secondary" type="button" id="btn-prev">Prev</button>
      <button class="btn btn-outline-secondary" type="button" id="btn-today">Today</button>
      <button class="btn btn-outline-secondary" type="button" id="btn-next">Next</button>
    </div>
    <input id="date-input" type="date" class="form-control" name="date" value="{{ target_date|date:'Y-m-d' }}">
    <button class="btn btn-outline-secondary" type="submit">Go</button>
  </form>
  <div class="text-muted small w-100 mt-1">Viewing: <strong>{{ target_date|date:'F d, Y' }}</strong> ({{ target_date|date:'l' }})</div>
  </div>

<div class="mt-3">
  <input id="filter-input" type="search" class="form-control" placeholder="Search learner by name..." autocomplete="off">
  <div class="form-text">Type to filter the list below.</div>
  </div>

<form id="attendance-form" method="post" class="mt-3">{% csrf_token %}
  {{ formset.management_form }}
  <input type="hidden" name="date" value="{{ target_date|date:'Y-m-d' }}">

  <div class="d-flex flex-wrap gap-2 mb-2 align-items-center">
    <button type="button" class="btn btn-sm btn-outline-success" id="btn-all-present">Mark ALL Present</button>
    <button type="button" class="btn btn-sm btn-outline-success" id="btn-am-present">AM Present</button>
    <button type="button" class="btn btn-sm btn-outline-success" id="btn-pm-present">PM Present</button>
    <span class="badge rounded-pill text-bg-secondary" id="marked-counter">Marked 0/0</span>
    <div class="form-check ms-auto">
      <input class="form-check-input" type="checkbox" id="chk-only-unmarked">
      <label class="form-check-label" for="chk-only-unmarked">Show only unmarked</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="chk-only-ale">
      <label class="form-check-label" for="chk-only-ale">Show only Absent/Late/Excused</label>
    </div>
    <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-next-ale">Jump to next A/L/E</button>
  </div>

  {% if periods %}
    <div class="alert alert-info">Per-period attendance enabled. Default is Present for all periods. Mark Late to capture time-in.</div>
    {% for e in enrollments_period %}
      <div class="card mb-2 shadow-sm student-card" data-name="{{ e.student_name|default:''|lower }}">
        <div class="card-body">
          <div class="mb-2 d-flex justify-content-between align-items-center gap-2 flex-wrap">
            <div class="student-name">{{ e.student_name }}</div>
            <div class="d-flex gap-1 flex-wrap">
              {% if e.guardian_phone %}
                <a href="#" class="btn btn-sm btn-outline-secondary js-sms"
                   data-phone="{{ e.guardian_phone|phone_e164 }}"
                   title="Compose SMS to parent">SMS</a>
              {% endif %}
            </div>
            <div class="d-flex gap-1 ms-auto">
              <button type="button" class="btn btn-sm btn-outline-success js-row-all-p" title="Mark all periods Present">All P</button>
              <button type="button" class="btn btn-sm btn-outline-secondary js-row-clear" title="Clear time-in and set Present">Clear</button>
            </div>
          </div>
          <div class="periods-wrap">
            {% for p in periods %}
            <div class="period-chip">
              <div class="title text-center">{{ p.name }}</div>
              <div class="sub text-center">{{ p.half }}</div>
              <div class="chip-group" role="group" aria-label="{{ p.name }}">
                <input type="radio" name="p_{{ e.enrollment_id }}_{{ p.id }}_status" id="p{{ e.enrollment_id }}_{{ p.id }}_P" value="P" {% if e.statuses|dict_get:p.id|default:'P' == 'P' %}checked{% endif %}>
                <label class="btn btn-outline-success" for="p{{ e.enrollment_id }}_{{ p.id }}_P">P</label>
                <input type="radio" name="p_{{ e.enrollment_id }}_{{ p.id }}_status" id="p{{ e.enrollment_id }}_{{ p.id }}_A" value="A" {% if e.statuses|dict_get:p.id == 'A' %}checked{% endif %}>
                <label class="btn btn-outline-danger" for="p{{ e.enrollment_id }}_{{ p.id }}_A">A</label>
                <input type="radio" name="p_{{ e.enrollment_id }}_{{ p.id }}_status" id="p{{ e.enrollment_id }}_{{ p.id }}_L" value="L" {% if e.statuses|dict_get:p.id == 'L' %}checked{% endif %}>
                <label class="btn btn-outline-warning" for="p{{ e.enrollment_id }}_{{ p.id }}_L">L</label>
                <input type="radio" name="p_{{ e.enrollment_id }}_{{ p.id }}_status" id="p{{ e.enrollment_id }}_{{ p.id }}_E" value="E" {% if e.statuses|dict_get:p.id == 'E' %}checked{% endif %}>
                <label class="btn btn-outline-info" for="p{{ e.enrollment_id }}_{{ p.id }}_E">E</label>
              </div>
              <div class="time">
                <input type="time" class="form-control form-control-sm" name="ti_{{ e.enrollment_id }}_{{ p.id }}" lang="en-GB" placeholder="HH:MM" step="60" inputmode="numeric" value="{{ e.time_in|dict_get:p.id }}">
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    {% empty %}
      <div class="alert alert-info">No enrolled students.</div>
    {% endfor %}
  {% else %}
  {% for form in formset %}
    {{ form.enrollment_id }}
    {# keep the disabled input in DOM but hide it; render name as heading for space #}
    <div class="card mb-2 shadow-sm student-card" data-name="{{ form.initial.student_name|default:''|lower }}">
      <div class="card-body">
        <div class="mb-2 d-flex justify-content-between align-items-center gap-2 flex-wrap">
          <div class="student-name">{{ form.initial.student_name }}</div>
          <div class="d-flex gap-1 flex-wrap">
            {% if form.initial.guardian_phone %}
              <a href="#" class="btn btn-sm btn-outline-secondary js-sms"
                 data-phone="{{ form.initial.guardian_phone|phone_e164 }}"
                 title="Compose SMS to parent">SMS</a>
            {% endif %}
          </div>
          <div class="d-none">{{ form.student_name }}</div>
        </div>
        <div class="row g-2 align-items-center">
          <div class="col-12 col-sm-6">
            <div class="mb-1"><span class="text-muted small me-2">AM</span>
              <div class="att-status" role="group" aria-label="Status AM">
                {% for opt in form.status_am %}
                  {{ opt.tag }}
                  {% with val=opt.data.value %}
                  <label class="btn {% if val == 'P' %}btn-outline-success{% elif val == 'A' %}btn-outline-danger{% elif val == 'L' %}btn-outline-warning{% elif val == 'E' %}btn-outline-info{% else %}btn-outline-primary{% endif %}" for="{{ opt.id_for_label }}">{{ opt.choice_label }}</label>
                  {% endwith %}
                {% endfor %}
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-6">
            <div class="mb-1"><span class="text-muted small me-2">PM</span>
              <div class="att-status" role="group" aria-label="Status PM">
                {% for opt in form.status_pm %}
                  {{ opt.tag }}
                  {% with val=opt.data.value %}
                  <label class="btn {% if val == 'P' %}btn-outline-success{% elif val == 'A' %}btn-outline-danger{% elif val == 'L' %}btn-outline-warning{% elif val == 'E' %}btn-outline-info{% else %}btn-outline-primary{% endif %}" for="{{ opt.id_for_label }}">{{ opt.choice_label }}</label>
                  {% endwith %}
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        <div class="mt-2">
          <button type="button" class="btn btn-sm btn-outline-secondary" data-toggle-remarks>+ Add note</button>
          <div class="mt-2 d-none" data-remarks-area>
            <label class="form-label mb-1">Remarks</label>
            {{ form.remarks }}
          </div>
        </div>
      </div>
    </div>
  {% empty %}
    <div class="alert alert-info">No enrolled students.</div>
  {% endfor %}
  {% endif %}
</form>

<div class="action-bar border-top bg-body">
  <div class="inner container d-flex flex-column flex-sm-row gap-2">
    <div class="btn-group w-100">
      <button class="btn btn-outline-secondary d-none d-sm-inline" id="btn-prev-day" type="button">Prev Day</button>
      <button class="btn btn-primary flex-fill" id="btn-save" type="submit" form="attendance-form">Save</button>
      <button class="btn btn-outline-secondary d-none d-sm-inline" id="btn-next-day" type="button">Next Day</button>
    </div>
    <a class="btn btn-outline-secondary w-100 w-sm-auto" href="{% url 'attendance:schoolyear_list' %}">Back</a>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Simple client-side filter by learner name
  (function(){
    const input = document.getElementById('filter-input');
    if (!input) return;
    const cards = Array.from(document.querySelectorAll('.student-card'));
    input.addEventListener('input', function(){
      const q = this.value.trim().toLowerCase();
      cards.forEach(c => {
        const name = (c.getAttribute('data-name') || '');
        c.style.display = (!q || name.includes(q)) ? '' : 'none';
      });
    });
  })();
</script>
<script>
  // Date UX + Unsaved guard + shortcuts
  (function(){
    const navForm = document.getElementById('date-form');
    const dateInput = document.getElementById('date-input');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');
    const btnToday = document.getElementById('btn-today');
    const attForm = document.getElementById('attendance-form');
    if (!navForm || !dateInput) return;

    // Track dirty state
    let dirty = false;
    window.__attendSubmitting = false;
    if (attForm){
      attForm.addEventListener('change', (e)=>{
        const t = e.target;
        if (!t) return;
        if (t.matches('input[type="radio"], textarea, input[type="text"]')) dirty = true;
      }, { passive: true });
    }
    window.addEventListener('beforeunload', function(e){
      if (window.__attendSubmitting) return;
      if (!dirty) return;
      e.preventDefault();
      e.returnValue = '';
    });

    function iso(d){ return new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
    function fmt(d){ try { return d.toLocaleDateString(undefined, { year:'numeric', month:'long', day:'2-digit' }); } catch(e) { return iso(d); } }
    function getDate(){
      const v = dateInput.value || '';
      if (!v) return null;
      const parts = v.split('-').map(Number);
      return new Date(parts[0], parts[1]-1, parts[2]);
    }
    function confirmIfDirty(){
      return !dirty || confirm('You have unsaved changes. Continue and discard them?');
    }
    function setAndSubmit(d){
      if (!confirmIfDirty()) return;
      dateInput.value = iso(d);
      try { navForm.requestSubmit ? navForm.requestSubmit() : navForm.submit(); } catch(e){ navForm.submit(); }
    }

    dateInput.addEventListener('change', function(){ setAndSubmit(getDate() || new Date()); });
    if (btnPrev) btnPrev.addEventListener('click', function(){ const d=getDate()||new Date(); d.setDate(d.getDate()-1); setAndSubmit(d); });
    if (btnNext) btnNext.addEventListener('click', function(){ const d=getDate()||new Date(); d.setDate(d.getDate()+1); setAndSubmit(d); });
    if (btnToday) btnToday.addEventListener('click', function(){ setAndSubmit(new Date()); });

    // Keyboard shortcuts: Left/Right arrows to move day
    window.addEventListener('keydown', function(e){
      if (e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
      if (e.key === 'ArrowLeft'){ const d=getDate()||new Date(); d.setDate(d.getDate()-1); setAndSubmit(d); }
      if (e.key === 'ArrowRight'){ const d=getDate()||new Date(); d.setDate(d.getDate()+1); setAndSubmit(d); }
      if (e.key.toLowerCase() === 't'){ setAndSubmit(new Date()); }
    });

    try {
      // Move toast container to top-right so it does not block the Save bar
      const tc = document.getElementById('toastContainer');
      if (tc){ tc.style.top='1rem'; tc.style.bottom='auto'; tc.style.left='auto'; tc.style.right='1rem'; tc.style.transform='none'; }
      const v = dateInput.value;
      if (v && window.showToast){
        const p = v.split('-').map(Number); const d = new Date(p[0], p[1]-1, p[2]);
        window.showToast('Showing attendance for ' + fmt(d), 'info');
      }
    } catch(e) {}
  })();
</script>
<script>
  // Preserve scroll on save and show a toast when returning
  (function(){
    const form = document.getElementById('attendance-form');
    // Hook prev/next day via hidden nav field
    const navInput = document.createElement('input');
    navInput.type = 'hidden'; navInput.name = 'nav';
    form && form.appendChild(navInput);
    function submitWithNav(val){
      if (!form) return;
      navInput.value = val;
      form.requestSubmit ? form.requestSubmit() : form.submit();
    }
    document.getElementById('btn-prev-day')?.addEventListener('click', ()=> submitWithNav('prev'));
    document.getElementById('btn-next-day')?.addEventListener('click', ()=> submitWithNav('next'));
    let submitting = false;
    if (form) {
      form.addEventListener('submit', function(){
        try {
          sessionStorage.setItem('attend_scroll', String(window.scrollY || window.pageYOffset || 0));
          sessionStorage.setItem('attend_saved', '1');
        } catch(e) {}
        submitting = true;
        window.__attendSubmitting = true;
      });
    }
    // Prevent false warning when we are actually submitting
    window.addEventListener('beforeunload', function(e){
      if (submitting) return;
    });
    window.addEventListener('DOMContentLoaded', function(){
      const params = new URLSearchParams(window.location.search);
      const savedParam = params.get('saved') === '1';
      let savedFlag = false;
      try { savedFlag = sessionStorage.getItem('attend_saved') === '1'; } catch(e) {}
      if (savedParam || savedFlag) {
        // Scroll restore
        try {
          const y = parseInt(sessionStorage.getItem('attend_scroll') || '0', 10);
          if (!isNaN(y) && y > 0) { setTimeout(()=> window.scrollTo({top: y, behavior: 'auto'}), 0); }
          sessionStorage.removeItem('attend_scroll');
          sessionStorage.removeItem('attend_saved');
        } catch(e) {}
        // Rely on Django message toast; do not show a second duplicate toast here
      }
    });
  })();
</script>
<script>
  // Open SMS compose with platform-appropriate format
  (function(){
    function isiOS(){ return /iPhone|iPad|iPod/i.test(navigator.userAgent); }
    document.addEventListener('click', function(e){
      var t = e.target;
      if (t && t.classList && t.classList.contains('js-sms')){
        e.preventDefault();
        var card = t.closest('.student-card');
        var nameEl = card ? card.querySelector('.student-name') : null;
        var name = nameEl ? nameEl.textContent.trim() : 'Student';
        // Find selected statuses within this card
        function sel(nameSuffix){
          var input = card ? card.querySelector('input[name$="' + nameSuffix + '"]:checked') : null;
          return input ? (input.value || 'P') : 'P';
        }
        function word(code){
          switch(code){ case 'A': return 'Absent'; case 'L': return 'Late'; case 'E': return 'Excused'; default: return 'Present'; }
        }
        var am = sel('status_am');
        var pm = sel('status_pm');
        // Build Ilokano prefilled text.
        // If any session is Absent, use the ABSENT-only message (per request).
        var bodyText;
        if (am === 'A' || pm === 'A') {
          bodyText = 'Naimbag nga aldaw, parent. Maipakaammo nga ni ' + name + ' ket ABSENT ita nga aldaw. Thank you';
        } else {
          // If AM and PM same (e.g., both Present/Late/Excused), show one context; else show both.
          var contextText = (am === pm) ? (word(am)) : ('AM: ' + word(am) + '; PM: ' + word(pm));
          bodyText = 'Naimbag nga aldaw, parent. Maipakaammo nga ni ' + name + ' ket ' + contextText + ' ita nga aldaw. Thank you';
        }
        var enc = encodeURIComponent(bodyText);
        var phone = t.getAttribute('data-phone') || '';
        var href = isiOS() ? ('sms:' + phone + '&body=' + enc) : ('sms:' + phone + '?body=' + enc);
        window.location.href = href;
      }
    }, { passive: false });
  })();
</script>
<script>
  // Auto time-in on Late, and enable/disable time inputs accordingly
  (function(){
    function nowHM(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${hh}:${mm}`;
    }
    function pairTimeInput(radio){
      // radio name: p_<enrollmentId>_<periodId>_status
      const name = radio && radio.name ? radio.name : '';
      const m = name.match(/^p_(\d+)_(\d+)_status$/);
      if (!m) return null;
      const eid = m[1], pid = m[2];
      return document.querySelector(`input[type="time"][name="ti_${eid}_${pid}"]`);
    }
    function applyState(radio){
      const ti = pairTimeInput(radio);
      if (!ti) return;
      if (radio.value === 'L' && radio.checked){
        ti.disabled = false;
        // Show the time input when Late is selected
        const wrap = ti.closest('.time'); if (wrap) wrap.style.display = '';
        if (!ti.value){ ti.value = nowHM(); }
      } else if (radio.checked) {
        // If switching away from Late on this group, clear and disable and hide
        ti.value = '';
        ti.disabled = true;
        const wrap = ti.closest('.time'); if (wrap) wrap.style.display = 'none';
      }
    }
    // On load: disable all time inputs unless corresponding Late is selected or a value exists
    document.querySelectorAll('input[type="time"][name^="ti_"]').forEach(ti => {
      if (ti.value) { ti.disabled = false; const w=ti.closest('.time'); if (w) w.style.display=''; return; }
      // find group's radios
      const parts = (ti.getAttribute('name')||'').match(/^ti_(\d+)_(\d+)$/);
      if (!parts) { ti.disabled = true; return; }
      const eid = parts[1], pid = parts[2];
      const late = document.getElementById(`p${eid}_${pid}_L`);
      if (late && late.checked){ ti.disabled = false; const w=ti.closest('.time'); if (w) w.style.display=''; if (!ti.value) ti.value = nowHM(); }
      else { ti.disabled = true; const w=ti.closest('.time'); if (w) w.style.display='none'; }
    });
    function setGroupValue(card, groupName, value){
      const target = card.querySelector(`input[type=radio][name="${CSS.escape(groupName)}"][value="${value}"]`);
      if (target){
        target.checked = true;
        applyState(target);
        // ensure other radios in the same group clear their time inputs if any
        const siblings = card.querySelectorAll(`input[type=radio][name="${CSS.escape(groupName)}"]`);
        siblings.forEach(r => { if (r !== target) applyState(r); });
      }
    }
    function listGroupNames(card){
      const names = [];
      const seen = new Set();
      card.querySelectorAll('input[type=radio][name^="p_"]').forEach(r => {
        const nm = r.name;
        if (!seen.has(nm)){ seen.add(nm); names.push(nm); }
      });
      return names;
    }
    function cascadeFrom(card, changedName, value){
      const names = listGroupNames(card);
      const idx = names.indexOf(changedName);
      if (idx < 0) return;
      if (value === 'A'){
        for (let i = idx; i < names.length; i++) setGroupValue(card, names[i], 'A');
      } else if (value === 'P'){
        for (let i = idx; i < names.length; i++) setGroupValue(card, names[i], 'P');
      } else if (value === 'L'){
        // current late with time-in; succeeding present
        setGroupValue(card, names[idx], 'L');
        for (let i = idx+1; i < names.length; i++) setGroupValue(card, names[i], 'P');
      } else if (value === 'E'){
        // mark excused from here to end
        for (let i = idx; i < names.length; i++) setGroupValue(card, names[i], 'E');
      }
    }
    // Listen for any status change and apply + cascade
    document.addEventListener('change', function(e){
      const t = e.target;
      if (!t || t.type !== 'radio') return;
      applyState(t);
      if (t.name && /^p_\d+_\d+_status$/.test(t.name)){
        const card = t.closest('.student-card');
        if (card) cascadeFrom(card, t.name, t.value);
      }
    }, { passive: true });

    // Quick jump to next A/L/E row
    (function(){
      const btn = document.getElementById('btn-next-ale'); if (!btn) return;
      function hasAnyALE(card){
        const sel = card.querySelectorAll('input[type=radio][name^="p_"]:checked');
        for (const r of sel){ if (r.value !== 'P') return true; }
        const am = card.querySelector('input[type=radio][name$="status_am"]:checked');
        const pm = card.querySelector('input[type=radio][name$="status_pm"]:checked');
        return (am && am.value !== 'P') || (pm && pm.value !== 'P');
      }
      btn.addEventListener('click', function(){
        const cards = Array.from(document.querySelectorAll('.student-card'));
        const y = window.scrollY || 0;
        const next = cards.find(c => (c.getBoundingClientRect().top + y) > y + 8 && hasAnyALE(c));
        if (next){ next.scrollIntoView({behavior:'smooth', block:'start'}); }
        else if (window.showToast){ window.showToast('No next A/L/E row', 'info'); }
      });
    })();
  })();
</script>
<script>
  // Haptics, counter, and remarks toggles
  (function(){
    const form = document.getElementById('attendance-form');
    const counter = document.getElementById('marked-counter');
    const cards = Array.from(document.querySelectorAll('.student-card'));
    function hasBothSelected(card){
      // Per-period mode: ensure each period group has a checked radio
      const perAll = card.querySelectorAll('input[type=radio][name^="p_"]');
      if (perAll && perAll.length){
        const groupNames = new Set(Array.from(perAll).map(r => r.name));
        const checkedNames = new Set(Array.from(card.querySelectorAll('input[type=radio][name^="p_"]:checked')).map(r => r.name));
        return checkedNames.size === groupNames.size;
      }
      // AM/PM mode fallback
      const am = card.querySelector('input[type=radio][name$="status_am"]:checked');
      const pm = card.querySelector('input[type=radio][name$="status_pm"]:checked');
      return !!(am && pm);
    }
    function updateCounter(){
      const total = cards.length || 0;
      const marked = cards.filter(hasBothSelected).length;
      if (counter) counter.textContent = `Marked ${marked}/${total}`;
    }
    // Initialize
    updateCounter();
    if (form){
      form.addEventListener('change', function(e){
        const t = e.target;
        if (t && t.matches('input[type=radio]')){
          if (navigator.vibrate) try { navigator.vibrate(15); } catch(_) {}
          updateCounter();
        }
      }, { passive: true });
    }
    // Remarks toggles
    document.addEventListener('click', function(e){
      const btn = e.target.closest('[data-toggle-remarks]');
      if (!btn) return;
      const card = btn.closest('.student-card');
      const area = card && card.querySelector('[data-remarks-area]');
      if (!area) return;
      area.classList.toggle('d-none');
      btn.textContent = area.classList.contains('d-none') ? '+ Add note' : 'Hide note';
    });
  })();
</script>
<script>
  // Mobile helpers: search filter and quick mark actions
  (function(){
    const form = document.getElementById('attendance-form');
    if (!form) return;
    // Filter by name
    const input = document.getElementById('filter-input');
    const cards = Array.from(document.querySelectorAll('.student-card'));
    function applyFilter(){
      if (!input) return;
      const q = (input.value || '').trim().toLowerCase();
      cards.forEach(c => {
        const hay = (c.getAttribute('data-name') || '').toLowerCase();
        c.style.display = (!q || hay.includes(q)) ? '' : 'none';
      });
    }
    if (input) input.addEventListener('input', applyFilter, { passive: true });

    // Quick mark buttons
    function setAll(suffix, value){
      const radios = form.querySelectorAll(`input[type=radio][name$="${suffix}"]`);
      const names = new Set(Array.from(radios).map(r => r.name));
      names.forEach(n => {
        const r = form.querySelector(`input[type=radio][name="${CSS.escape(n)}"][value="${value}"]`);
        if (r) r.checked = true;
      });
    }
    document.getElementById('btn-all-present')?.addEventListener('click', ()=>{
      setAll('status_am', 'P');
      setAll('status_pm', 'P');
      if (window.showToast) window.showToast('Marked all AM/PM as Present', 'success');
    });
    document.getElementById('btn-am-present')?.addEventListener('click', ()=>{
      setAll('status_am', 'P');
      if (window.showToast) window.showToast('Marked AM as Present', 'success');
    });
    document.getElementById('btn-pm-present')?.addEventListener('click', ()=>{
      setAll('status_pm', 'P');
      if (window.showToast) window.showToast('Marked PM as Present', 'success');
    });

    // Show only unmarked toggle
    const chkOnly = document.getElementById('chk-only-unmarked');
    const chkALE = document.getElementById('chk-only-ale');
    function hasBothSelected(card){
      const am = card.querySelector('input[type=radio][name$="status_am"]:checked');
      const pm = card.querySelector('input[type=radio][name$="status_pm"]:checked');
      return !!(am && pm);
    }
    function hasAnyALE(card){
      // Per-period mode: any selected radio not P
      const per = card.querySelectorAll('input[type=radio][name^="p_"]:checked');
      if (per && per.length){
        for (const r of per){ if (r.value !== 'P') return true; }
        return false;
      }
      // AM/PM mode
      const am = card.querySelector('input[type=radio][name$="status_am"]:checked');
      const pm = card.querySelector('input[type=radio][name$="status_pm"]:checked');
      return (am && am.value !== 'P') || (pm && pm.value !== 'P');
    }
    function applyOnlyUnmarked(){
      const enabled = !!(chkOnly && chkOnly.checked);
      cards.forEach(card => { card.style.display = (enabled && hasBothSelected(card)) ? 'none' : ''; });
    }
    function applyOnlyALE(){
      const enabled = !!(chkALE && chkALE.checked);
      cards.forEach(card => { card.style.display = (enabled && !hasAnyALE(card)) ? 'none' : ''; });
    }
    if (chkOnly) chkOnly.addEventListener('change', applyOnlyUnmarked);
    if (chkALE) chkALE.addEventListener('change', applyOnlyALE);

    // Per-row helpers
    function setRowAllPresent(card){
      const radios = card.querySelectorAll('input[type=radio][name^="p_"]');
      const names = new Set(Array.from(radios).map(r => r.name));
      names.forEach(n => {
        const r = card.querySelector(`input[type=radio][name="${CSS.escape(n)}"][value="P"]`);
        if (r){ r.checked = true; }
      });
      // Clear time-ins
      card.querySelectorAll('input[type="time"][name^="ti_"]').forEach(ti => { ti.value=''; ti.disabled=true; });
      if (window.showToast) window.showToast('Set all periods to Present', 'success');
    }
    document.addEventListener('click', function(e){
      const btnP = e.target.closest('.js-row-all-p');
      if (btnP){ e.preventDefault(); const card = btnP.closest('.student-card'); if (card) setRowAllPresent(card); }
      const btnC = e.target.closest('.js-row-clear');
      if (btnC){ e.preventDefault(); const card = btnC.closest('.student-card'); if (card) setRowAllPresent(card); }
    }, { passive: false });
  })();
</script>
<!-- Removed auto-fill rule for AM Absent -> PM Absent per request -->
{% endblock %}
