{% extends 'attendance/base.html' %}
{% block content %}
<h1 class="h4">Enroll Students: {{ schoolyear.name }}</h1>

<form method="post" class="mt-3">{% csrf_token %}
  <div class="row g-2 align-items-end">
    <div class="col-sm-6">
      <label class="form-label">Search</label>
      <input id="enr-filter" type="search" class="form-control" placeholder="Type name to filter..." autocomplete="off">
    </div>
    <div class="col-sm-6 d-flex gap-2 mt-4">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="only-not-enrolled">
        <label class="form-check-label" for="only-not-enrolled">Show only not enrolled</label>
      </div>
      <div class="ms-auto d-flex gap-2 align-items-center">
        <div class="small text-muted me-2"><span id="visible-count">0</span> visible</div>
        <button class="btn btn-outline-secondary btn-sm" type="button" id="btn-select-all">Select all visible</button>
        <button class="btn btn-outline-secondary btn-sm" type="button" id="btn-clear-all">Clear all</button>
      </div>
    </div>
  </div>

  <div class="list-group mt-2" id="enr-list">
    {% for s in students %}
      <label class="list-group-item d-flex align-items-center justify-content-between" data-q="{{ s.last_name }} {{ s.first_name }}" data-enrolled="{% if s.id in enrolled_ids %}1{% else %}0{% endif %}">
        <div class="d-flex align-items-center">
          <input class="form-check-input me-2 js-cb" type="checkbox" name="student_ids" value="{{ s.id }}" {% if s.id in enrolled_ids %}checked{% endif %}>
          <span>{{ s.last_name }}, {{ s.first_name }} ({{ s.sex }})</span>
        </div>
        {% if s.id in enrolled_ids %}<span class="badge text-bg-secondary">Enrolled</span>{% endif %}
      </label>
    {% empty %}
      <div class="text-muted">No students to enroll yet.</div>
    {% endfor %}
  </div>
  <div class="form-text mt-1">Note: Unchecking a currently enrolled learner does not unenroll them here.</div>
  <div class="d-flex gap-2 mt-3">
    <button class="btn btn-primary flex-fill" type="submit">Save Enrollment</button>
    <a class="btn btn-outline-secondary" href="{% url 'attendance:schoolyear_list' %}">Back</a>
  </div>
</form>
{% block extra_js %}
<script>
  (function(){
    const filter = document.getElementById('enr-filter');
    const onlyNew = document.getElementById('only-not-enrolled');
    const list = document.getElementById('enr-list');
    if (!list) return;
    const rows = Array.from(list.querySelectorAll('.list-group-item'));
    const countEl = document.getElementById('visible-count');

    // Restore state (default: toggle OFF)
    try {
      const savedQ = sessionStorage.getItem('enr_filter_q');
      const savedOnly = sessionStorage.getItem('enr_only') === '1';
      if (savedQ !== null && filter) filter.value = savedQ;
      if (onlyNew) onlyNew.checked = !!savedOnly;
    } catch(e) {}

    function apply(){
      const q = (filter && filter.value || '').trim().toLowerCase();
      const only = !!(onlyNew && onlyNew.checked);
      rows.forEach(r => {
        const hay = (r.getAttribute('data-q') || '').toLowerCase();
        const enrolled = (r.getAttribute('data-enrolled') === '1');
        const okQ = (!q || hay.includes(q));
        const okNew = (!only || !enrolled);
        r.style.display = (okQ && okNew) ? '' : 'none';
      });
      if (countEl) {
        let vis = 0; rows.forEach(r => { if (r.style.display !== 'none') vis++; });
        countEl.textContent = String(vis);
      }
      try {
        if (filter) sessionStorage.setItem('enr_filter_q', q);
        sessionStorage.setItem('enr_only', only ? '1' : '0');
      } catch(e) {}
    }
    if (filter) filter.addEventListener('input', ()=>{ window.clearTimeout(window.__enr_d); window.__enr_d=setTimeout(apply,120); }, { passive: true });
    if (onlyNew) onlyNew.addEventListener('change', apply);
    apply();

    const btnAll = document.getElementById('btn-select-all');
    const btnClear = document.getElementById('btn-clear-all');
    if (btnAll) btnAll.addEventListener('click', function(){
      rows.forEach(r => { if (r.style.display !== 'none'){ const cb=r.querySelector('.js-cb'); if(cb) cb.checked = true; } });
    });
    if (btnClear) btnClear.addEventListener('click', function(){ rows.forEach(r => { const cb=r.querySelector('.js-cb'); if(cb) cb.checked = false; }); });
  })();
</script>
{% endblock %}
{% endblock %}
