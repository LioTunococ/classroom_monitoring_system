{% extends 'attendance/base.html' %}
{% load phone_filters %}
{% block content %}
<h1 class="h5">{{ student.last_name }}, {{ student.first_name }} — History</h1>

<form method="get" class="row g-2 align-items-end mt-1">
  <input type="hidden" name="schoolyear_id" value="{{ schoolyear.id }}" />
  <div class="col-auto"><label class="form-label">SY</label>
    <input type="text" class="form-control" value="{{ schoolyear.name }}" disabled>
  </div>
  <div class="col-auto"><label class="form-label">Year</label>
    <input class="form-control" type="number" name="year" value="{{ year }}" min="2000" max="2100">
  </div>
  <div class="col-auto"><label class="form-label">Month</label>
    <input class="form-control" type="number" name="month" value="{{ month }}" min="1" max="12">
  </div>
  <div class="col-auto"><button class="btn btn-primary" type="submit">Go</button></div>
  {% if active_sy %}
  <div class="col-auto"><a class="btn btn-outline-secondary" href="{% url 'attendance:take_attendance' active_sy.id %}">Take Attendance</a></div>
  {% endif %}
</form>

{% if days %}
<style>
  .cal-dot{display:inline-block;width:10px;height:10px;border-radius:2px;margin:0 2px}
  @media (max-width:576px){ .cal-cell{min-width:3.2rem} }
  @media (min-width:577px){ .cal-cell{min-width:6rem} }
  .cal-day{font-size:.9rem;font-weight:600}
</style>

<div class="mt-3">
  <div class="d-flex align-items-center gap-2 small">
    <div>Status sparkline:</div>
    <div class="d-flex" style="gap:2px;">
      {% for e in entries %}
        <span title="{{ e.day|date:'M d' }} — {{ e.am }}/{{ e.pm }}" style="display:inline-block;width:8px;height:10px;border-radius:2px; background:
          {% if e.sev == 'abs' %}#dc3545{% elif e.sev == 'late' %}#ffc107{% elif e.sev == 'exc' %}#0dcaf0{% else %}#198754{% endif %};
        "></span>
      {% endfor %}
    </div>
    <div class="ms-3 small text-muted">Green=P, Red=A, Yellow=L, Blue=E</div>
  </div>
</div>

<div class="table-responsive mt-3">
  <table class="table table-bordered align-middle text-center mb-0">
    <thead class="table-light">
      <tr>
        <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
      </tr>
    </thead>
    <tbody>
      {% for week in weeks %}
      <tr>
        {% for d in week %}
          {% with e=entry_by_date|dict_get:d %}
          <td class="cal-cell {% if d.month != month %}text-muted bg-light{% endif %} {% if nsd_dates and d in nsd_dates %}table-secondary{% endif %} {% if d < schoolyear.start_date or d > schoolyear.end_date %}opacity-50{% endif %}" title="{{ d|date:'M d, Y' }}{% if e %} — {{ e.am }}/{{ e.pm }}{% endif %}">
            <div class="cal-day">{{ d|date:'j' }}</div>
            <div>
              {% if e %}
                <span class="cal-dot" style="background:{% if e.am == 'A' %}#dc3545{% elif e.am == 'L' %}#ffc107{% elif e.am == 'E' %}#0dcaf0{% elif e.am == 'P' %}#198754{% else %}#adb5bd{% endif %}"></span>
                <span class="cal-dot" style="background:{% if e.pm == 'A' %}#dc3545{% elif e.pm == 'L' %}#ffc107{% elif e.pm == 'E' %}#0dcaf0{% elif e.pm == 'P' %}#198754{% else %}#adb5bd{% endif %}"></span>
              {% else %}
                <span class="text-muted small">—</span>
              {% endif %}
            </div>
          </td>
          {% endwith %}
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="small text-muted mt-1">Shaded = Non-School Day. Grey = outside selected month.</div>
</div>

<div class="table-responsive mt-3">
  <table class="table table-sm table-bordered align-middle text-center w-auto">
    <thead class="table-light">
      <tr>
        <th>Date</th>
        <th>Day</th>
        <th>AM/PM</th>
        <th class="text-start">Remarks</th>
      </tr>
    </thead>
    <tbody>
      {% for e in entries %}
        <tr class="{% if nsd_dates and e.day in nsd_dates %}table-secondary{% endif %}">
          <td>{{ e.day|date:'Y-m-d' }}</td>
          <td>{{ e.day|date:'D' }}</td>
          <td><strong>{{ e.am|default:'' }}/{{ e.pm|default:'' }}</strong></td>
          <td class="text-start">{{ e.remarks }}</td>
        </tr>
      {% endfor %}
      {% if not entries %}
        <tr><td colspan="4" class="text-muted">No records for the selected month.</td></tr>
      {% endif %}
    </tbody>
    <tfoot>
      <tr class="fw-semibold">
        <td colspan="2" class="text-end">Totals</td>
        <td colspan="2" class="text-start">
          P: {{ counts.P|default:0 }} &nbsp; A: {{ counts.A|default:0 }} &nbsp; L: {{ counts.L|default:0 }} &nbsp; E: {{ counts.E|default:0 }}
        </td>
      </tr>
    </tfoot>
  </table>
</div>
{% else %}
  <div class="alert alert-info mt-3">No days in range for this month and school year.</div>
{% endif %}
{% endblock %}
