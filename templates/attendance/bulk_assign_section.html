{% extends 'attendance/base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center">
  <h1 class="h4">Bulk Assign Section: {{ schoolyear.name }}</h1>
  <a class="btn btn-outline-secondary" href="{% url 'attendance:take_attendance' schoolyear.id %}">Back to Attendance</a>
  </div>

<form method="post" class="mt-3">{% csrf_token %}
  <div class="row g-2 align-items-end">
    <div class="col-md-6">
      <label class="form-label">Section to assign</label>
      <select class="form-select" name="section_id" required>
        <option value="">-- Choose Section --</option>
        {% for sec in sections %}
          <option value="{{ sec.id }}">{{ sec.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3 d-flex align-items-center">
      <div class="form-check mt-4">
        <input class="form-check-input" type="checkbox" id="only-unassigned">
        <label class="form-check-label" for="only-unassigned">Show only unassigned</label>
      </div>
    </div>
    <div class="col-md-3 text-end">
      <button class="btn btn-primary mt-4" type="submit">Assign to Selected</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped mt-3 align-middle">
      <thead>
        <tr>
          <th style="width:2rem"><input type="checkbox" id="chk-all" onclick="document.querySelectorAll('input[name=\'enrollment_ids\']:not(:disabled)').forEach(cb=>cb.checked=this.checked)"></th>
          <th>#</th>
          <th>Learner</th>
          <th>Current Section</th>
        </tr>
      </thead>
      <tbody>
        {% for e in enrollments %}
        <tr class="js-row" data-section="{{ e.section.name|default:'__NONE__' }}">
          <td>
            <input type="checkbox" name="enrollment_ids" value="{{ e.id }}">
          </td>
          <td>{{ forloop.counter }}</td>
          <td>{{ e.student.last_name }}, {{ e.student.first_name }}</td>
          <td>
            {% if e.section %}
              <span class="badge text-bg-secondary">{{ e.section.name }}</span>
            {% else %}
              <span class="text-muted">None</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="4" class="text-muted">No enrollments available.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <button class="btn btn-primary" type="submit">Assign to Selected</button>
</form>
{% block extra_js %}
<script>
  (function(){
    const select = document.querySelector('select[name="section_id"]');
    const onlyUnassigned = document.getElementById('only-unassigned');

    function refreshDisableForSameSection(){
      const chosen = select && select.options[select.selectedIndex] ? select.options[select.selectedIndex].text.trim() : '';
      document.querySelectorAll('tr.js-row').forEach(row => {
        const rowSec = (row.getAttribute('data-section') || '').trim();
        const cb = row.querySelector('input[type="checkbox"][name="enrollment_ids"]');
        if (!cb) return;
        if (chosen && rowSec && rowSec === chosen){
          cb.checked = false;
          cb.disabled = true;
          row.classList.add('table-light');
        } else {
          cb.disabled = false;
          row.classList.remove('table-light');
        }
      });
    }

    function applyOnlyUnassignedFilter(){
      const flag = !!(onlyUnassigned && onlyUnassigned.checked);
      document.querySelectorAll('tr.js-row').forEach(row => {
        const rowSec = row.getAttribute('data-section') || '';
        const isUnassigned = (rowSec === '__NONE__');
        row.style.display = (flag && !isUnassigned) ? 'none' : '';
      });
    }

    if (select) select.addEventListener('change', refreshDisableForSameSection);
    if (onlyUnassigned) onlyUnassigned.addEventListener('change', applyOnlyUnassignedFilter);
    window.addEventListener('DOMContentLoaded', function(){
      refreshDisableForSameSection();
      applyOnlyUnassignedFilter();
    });
  })();
  </script>
{% endblock %}
{% endblock %}
