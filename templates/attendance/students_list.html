{% extends 'attendance/base.html' %}
{% load phone_filters %}
{% block content %}
<div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
  <div class="d-flex align-items-center gap-3">
    <h1 class="h4 mb-0">Students</h1>
    {% if active_sy %}<span class="text-muted small">Active SY: <strong>{{ active_sy.name }}</strong></span>{% endif %}
  </div>
  <div class="d-flex gap-2">
    {% if active_sy %}
      <a class="btn btn-primary" href="{% url 'attendance:enroll_students' active_sy.id %}">Enroll Students</a>
      <a class="btn btn-outline-primary" href="{% url 'attendance:take_attendance' active_sy.id %}">Take Attendance</a>
    {% endif %}
    <a class="btn btn-success" href="{% url 'attendance:student_create' %}">Add Student</a>
  </div>
</div>

<div class="row g-2 mt-3 align-items-end sticky-filter">
  <div class="col-sm-8">
    <label class="form-label">Search</label>
    <input id="student-filter" type="search" class="form-control" placeholder="Search by name or LRN..." autocomplete="off">
  </div>
  <div class="col-sm-4">
    <div class="form-check mt-4">
      <input class="form-check-input" type="checkbox" id="toggle-archived" {% if show_archived %}checked{% endif %}>
      <label class="form-check-label" for="toggle-archived">Show archived students</label>
    </div>
  </div>
</div>

<div class="table-responsive mt-3">
  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th>LRN</th><th>Name</th><th>Sex</th><th>Birthdate</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="student-tbody">
      {% for s in students %}
        <tr data-q="{{ s.lrn }} {{ s.last_name }} {{ s.first_name }}">
          <td>{{ s.lrn }}</td>
          <td>{{ s.last_name }}, {{ s.first_name }}</td>
          <td>{{ s.sex }}</td>
          <td>{{ s.birthdate|default:'â€”' }}</td>
          <td class="actions">
            <a class="btn btn-sm btn-outline-primary" href="{% url 'attendance:student_edit' s.id %}">Edit</a>
            {% if s.guardian_phone %}
              {% with sms_msg="Attendance update for "|add:s.last_name|add:", "|add:s.first_name|add:". Please contact the adviser." %}
                <a href="#" class="btn btn-sm btn-outline-secondary js-sms"
                   data-phone="{{ s.guardian_phone|phone_e164 }}"
                   data-body="{{ sms_msg|urlencode }}"
                   title="Compose SMS to parent">SMS</a>
                <a class="btn btn-sm btn-outline-success"
                   target="_blank"
                   href="https://wa.me/{{ s.guardian_phone|phone_wa }}?text={{ sms_msg|urlencode }}"
                   title="Open WhatsApp chat">WhatsApp</a>
                <a class="btn btn-sm btn-outline-info"
                   href="viber://chat?number=%2B{{ s.guardian_phone|phone_no_plus }}"
                   title="Open Viber chat">Viber</a>
              {% endwith %}
            {% endif %}
            {% if s.is_active %}
              <a class="btn btn-sm btn-outline-warning" href="{% url 'attendance:student_archive' s.id %}">Archive</a>
            {% else %}
              <a class="btn btn-sm btn-outline-success" href="{% url 'attendance:student_restore' s.id %}">Restore</a>
              <a class="btn btn-sm btn-outline-danger" href="{% url 'attendance:student_delete' s.id %}">Hard Delete</a>
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="5" class="text-muted">No students yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    const input = document.getElementById('student-filter');
    const rows = Array.from(document.querySelectorAll('#student-tbody tr'));
    if (!input) return;
    let t = null;
    function apply(){
      const q = (input.value || '').trim().toLowerCase();
      rows.forEach(r => {
        const hay = (r.getAttribute('data-q') || '').toLowerCase();
        r.style.display = (!q || hay.includes(q)) ? '' : 'none';
      });
    }
    input.addEventListener('input', function(){
      if (t) clearTimeout(t);
      t = setTimeout(apply, 120);
    }, { passive: true });
  })();
</script>
<script>
  // Toggle archived filter by updating query param
  (function(){
    const chk = document.getElementById('toggle-archived');
    if (!chk) return;
    chk.addEventListener('change', function(){
      const url = new URL(window.location.href);
      if (this.checked) url.searchParams.set('archived','1'); else url.searchParams.delete('archived');
      window.location.href = url.toString();
    });
  })();
</script>
<script>
  // Open SMS compose with platform-appropriate format
  (function(){
    function isiOS(){ return /iPhone|iPad|iPod/i.test(navigator.userAgent); }
    document.addEventListener('click', function(e){
      var t = e.target;
      if (t && t.classList && t.classList.contains('js-sms')){
        e.preventDefault();
        var phone = t.getAttribute('data-phone') || '';
        var body = t.getAttribute('data-body') || '';
        // Some browsers need encodeURIComponent even if template did urlencode
        try { body = encodeURIComponent(decodeURIComponent(body)); } catch(_) {}
        var href = isiOS() ? ('sms:' + phone + '&body=' + body) : ('sms:' + phone + '?body=' + body);
        window.location.href = href;
      }
    }, { passive: false });
  })();
</script>
{% endblock %}
